{% load static %}
{% load thumbnail %}


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes Documents - UDSN Archives</title>
    <link rel="stylesheet" href="{% static 'base/css/style_accueil.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="{% static 'base/css/resultats.css' %}">
</head>
<body>
    <header class="header">
        <nav class="nav">
            <a href="{% url 'accueil' %}"><div class="logo">UDSN Archives</div></a>
            <a href="{% url 'dashboard' %}"><i class="fas fa-home"></i>Tableau de bord</a>
            <a href="{% url 'depot' %}"><i class="fas fa-upload"></i>Transfert</a>
            <div class="user-profile">
                <img src="https://ui-avatars.com/api/?name=User&background=e53935&color=fff" alt="Photo de profil" id="navAvatar">
                <span id="navUsername">Utilisateur</span>
            </div>
        </nav>
    </header>

    <main class="documents-container">
        <div class="documents-header">
            <div class="search-bar">
                   <form method="get" action="{% url 'recherche' %}" class="search-form">
                      <input type="text" name="titre" class="search-input" placeholder="Rechercher un document..." id="searchInput">
                        <button type="submit" class="btn-search" title="Rechercher">
                          <span class="icon-search"></span>
                        </button>
            </div>
        </div>
        <h1>Résultats pour "{{ query }}"</h1>
        <div class="documents-grid" id="documentsGrid">
            <!-- Les documents seront ajoutés ici dynamiquement -->
        </div>
        {% if resultats %}
            {% for document in resultats %}
                <p><h3><a href="{{document.fichier.url}}">{{ document.titre }}</a></h3></p>
                <img style="max-width:15%; height:auto;" src="{% thumbnail document.fichier 400x300 %}">
            {% endfor %}
        {% else %}
        <div class="empty-state" id="emptyState" style="display: none;">
            <i class="fas fa-folder-open"></i>
            <h2>Aucun document trouvé</h2>
            <p>Commencez à transférer vos documents pour les voir apparaître ici.</p>
            <a href="transfert_new.html" class="upload-btn">
                <i class="fas fa-upload"></i>
                Transférer un document
            </a>
        </div>
        {% endif %}
    </main>

    <footer class="footer">
        <p>&copy; 2025 UDSN Archives. Tous droits réservés.</p>
    </footer>

    <script>
        // Récupération des informations utilisateur
        const currentUser = localStorage.getItem('username') || 'Utilisateur';
        document.getElementById('navUsername').textContent = currentUser;

        // Chargement de l'avatar sauvegardé
        const savedAvatar = localStorage.getItem('userAvatar');
        if (savedAvatar) {
            document.getElementById('navAvatar').src = savedAvatar;
        }


        // Récupération des documents depuis le localStorage
        function getDocuments() {
            const documents = JSON.parse(localStorage.getItem('documents')) || [];
            const documentsGrid = document.getElementById('documentsGrid');
            const emptyState = document.getElementById('emptyState');

            if (documents.length === 0) {
                documentsGrid.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            documentsGrid.style.display = 'grid';
            emptyState.style.display = 'none';

            documentsGrid.innerHTML = documents.map(doc => `
                <div class="document-card">
                    <div class="document-icon">
                        <i class="fas ${getFileIcon(doc.type)}"></i>
                    </div>
                    <div class="document-info">
                        <h3>${doc.name}</h3>
                        <p>Taille: ${doc.size}</p>
                        <p>Type: ${doc.docType ? (doc.docType === 'cours' ? 'Cours' : 'Sujet') : 'Non spécifié'}</p>
                        <p>Transféré le: ${new Date(doc.date).toLocaleDateString()}</p>
                    </div>
                    <div class="document-actions">
                        <button class="action-btn" onclick="downloadDocument('${doc.id}')">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="action-btn" onclick="shareDocument('${doc.id}')">
                            <i class="fas fa-share-alt"></i>
                        </button>
                        <button class="action-btn" onclick="deleteDocument('${doc.id}')">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // Configuration des parcours par établissement
        const parcoursParEtablissement = {
            'ISSGEA': ['Science Géographiques', 'Sciences Environnementales', 'Aménagement du Territoire'],
            'ISAUBTP': ['Architecture', 'Urbanisme', 'Bâtiment et Travaux Publics'],
            'FSA': ['Biologie', 'Chimie', 'Physique', 'Maths Informatiques'],
            'EMHE': ['Hydraulique', 'Eau', 'Environnement', 'Génie Rural']
        };

        // Fonction pour mettre à jour les options de parcours
        function updateParcours() {
            const etablissement = document.getElementById('filterEtablissement').value;
            const parcoursSelect = document.getElementById('filterParcours');

            // Réinitialiser les options
            parcoursSelect.innerHTML = '<option value="all">Tous les parcours</option>';

            // Si un établissement spécifique est sélectionné, ajouter ses parcours
            if (etablissement !== 'all' && parcoursParEtablissement[etablissement]) {
                parcoursParEtablissement[etablissement].forEach(parcours => {
                    const option = document.createElement('option');
                    option.value = parcours;
                    option.textContent = `Parcours ${parcours}`;
                    parcoursSelect.appendChild(option);
                });
            }

            // Mettre à jour le filtrage des documents
            filterDocuments();
        }

        // Fonction de recherche et filtrage
        function filterDocuments() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const etablissementFilter = document.getElementById('filterEtablissement').value;
            const parcoursFilter = document.getElementById('filterParcours').value;
            const docTypeFilter = document.getElementById('filterDocType').value;
            const dateFilter = document.getElementById('filterDate').value;

            let documents = JSON.parse(localStorage.getItem('documents')) || [];

            // Filtrage par recherche
            if (searchTerm) {
                documents = documents.filter(doc =>
                    doc.name.toLowerCase().includes(searchTerm)
                );
            }

            // Filtrage par établissement
            if (etablissementFilter !== 'all') {
                documents = documents.filter(doc => doc.etablissement === etablissementFilter);
            }

            // Filtrage par parcours
            if (parcoursFilter !== 'all') {
                documents = documents.filter(doc => doc.parcours === parcoursFilter);
            }

            // Filtrage par type de document
            if (docTypeFilter !== 'all') {
                documents = documents.filter(doc => doc.docType === docTypeFilter);
            }

            // Filtrage par date
            const now = new Date();
            if (dateFilter === 'today') {
                documents = documents.filter(doc => {
                    const docDate = new Date(doc.date);
                    return docDate.toDateString() === now.toDateString();
                });
            } else if (dateFilter === 'week') {
                const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                documents = documents.filter(doc => {
                    const docDate = new Date(doc.date);
                    return docDate >= weekAgo;
                });
            } else if (dateFilter === 'month') {
                const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                documents = documents.filter(doc => {
                    const docDate = new Date(doc.date);
                    return docDate >= monthAgo;
                });
            }

            // Mise à jour de l'affichage
            localStorage.setItem('filteredDocuments', JSON.stringify(documents));
            getDocuments();
        }

        // Écouteurs d'événements pour la recherche et le filtrage
        document.getElementById('searchInput').addEventListener('input', filterDocuments);
        document.getElementById('filterEtablissement').addEventListener('change', filterDocuments);
        document.getElementById('filterParcours').addEventListener('change', filterDocuments);
        document.getElementById('filterDocType').addEventListener('change', filterDocuments);
        document.getElementById('filterDate').addEventListener('change', filterDocuments);

        // Fonctions pour les actions sur les documents
        function downloadDocument(id) {
            // Simulation de téléchargement
            alert('Téléchargement du document...');
        }

        function shareDocument(id) {
            // Simulation de partage
            alert('Fonctionnalité de partage à venir...');
        }

        function deleteDocument(id) {
            if (confirm('Êtes-vous sûr de vouloir supprimer ce document ?')) {
                let documents = JSON.parse(localStorage.getItem('documents')) || [];
                documents = documents.filter(doc => doc.id !== id);
                localStorage.setItem('documents', JSON.stringify(documents));
                getDocuments();
            }
        }

        // Chargement initial des documents
        getDocuments();
    </script>
</body>
</html>
