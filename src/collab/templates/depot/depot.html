{% load static %}

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transfert de fichiers - UDSN Archive</title>
    <link rel="stylesheet" href="{% static 'depot/css/style_accueil.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="{% static 'depot/css/depot.css' %}">
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo"><a href="{% url 'accueil' %}">UDSN Archives</a></div>
            <div class="user-profile"><a href="{% url 'dashboard' %}">
                <img src="https://ui-avatars.com/api/?name=User&background=e53935&color=fff" alt="Photo de profil">
                <span id="username">{{user.username}}</span></a>
            </div>
        </nav>
    </header>

    <main class="upload-container">
        <section class="upload-section">
            <h2><i class="fas fa-cloud-upload-alt"></i>Transférer un document</h2>

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <form method="post" enctype="multipart/form-data" class="form-publier" id="uploadForm">
                {% csrf_token %}
                <input type="hidden" name="submission_token" value="{{ submission_token }}">

                <!-- Titre du document -->
                <div class="form-grid full-width">
                    <div class="input-group">
                        <label for="{{ form.titre.id_for_label }}">Titre du document <span class="required">*</span></label>
                        {{ form.titre }}
                        {% if form.titre.errors %}
                            {% for error in form.titre.errors %}
                                <div class="error-message">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Première ligne : Faculté, Niveau et Année académique -->
                <div class="form-grid">
                    <div class="input-group">
                        <label for="{{ form.faculte.id_for_label }}">Faculté <span class="required">*</span></label>
                        {{ form.faculte }}
                        {% if form.faculte.errors %}
                            {% for error in form.faculte.errors %}
                                <div class="error-message">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="input-group">
                        <label for="{{ form.niveau.id_for_label }}">Niveau <span class="required">*</span></label>
                        {{ form.niveau }}
                        {% if form.niveau.errors %}
                            {% for error in form.niveau.errors %}
                                <div class="error-message">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="input-group">
                        <label for="{{ form.annee_academique.id_for_label }}">Année académique <span class="required">*</span></label>
                        {{ form.annee_academique }}
                        {% if form.annee_academique.errors %}
                            {% for error in form.annee_academique.errors %}
                                <div class="error-message">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Deuxième ligne : Filière et Matière -->
                <div class="form-grid">
                    <div class="input-group">
                        <label for="{{ form.filiere.id_for_label }}">Filière <span class="required">*</span></label>
                        {{ form.filiere }}
                        {% if form.filiere.errors %}
                            {% for error in form.filiere.errors %}
                                <div class="error-message">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                    <div class="input-group">
                        <label for="{{ form.matiere.id_for_label }}">Matière <span class="required">*</span></label>
                        {{ form.matiere }}
                        {% if form.matiere.errors %}
                            {% for error in form.matiere.errors %}
                                <div class="error-message">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Type de document -->
                <div class="form-grid">
                    <div class="input-group">
                        <label for="{{ form.type.id_for_label }}">Type de document</label>
                        {{ form.type }}
                        {% if form.type.errors %}
                            {% for error in form.type.errors %}
                                <div class="error-message">{{ error }}</div>
                            {% endfor %}
                        {% endif %}
                    </div>
                </div>

                <!-- Zone de dépôt de fichier -->
<!--                <div class="file-drop-zone" id="dropZone">
                    <i class="fas fa-file-upload"></i>
                    <h3>Déposez votre fichier ici</h3>
                    <p>ou cliquez pour sélectionner</p>
                    <p><small>Formats acceptés : PDF, DOC, DOCX, etc.</small></p>
                </div>

                {{ form.fichier }}
                {% if form.fichier.errors %}
                    {% for error in form.fichier.errors %}
                        <div class="error-message">{{ error }}</div>
                    {% endfor %}
                {% endif %}
-->
<!-- Zone de dépôt de fichier -->
<div class="file-drop-zone" id="dropZone">
    <i class="fas fa-file-upload"></i>
    <h3>Déposez votre fichier ici</h3>
    <p>ou cliquez pour sélectionner</p>
    <p><small>Formats acceptés : PDF, DOC, DOCX, etc.</small></p>
</div>

<!-- input du formulaire Django, caché -->
{{ form.fichier}}
{% if form.fichier.errors %}
    {% for error in form.fichier.errors %}
        <div class="error-message">{{ error }}</div>
    {% endfor %}
{% endif %}
                <button type="submit" class="upload-btn">
                    <i class="fas fa-upload"></i>
                    Envoyer le document
                </button>
            </form>
        </section>

        <section class="recent-files">
            <h3><i class="fas fa-history"></i>Documents récemment ajoutés</h3>
            <ul class="file-list" id="recentList">
                <!-- Les fichiers récents seront chargés ici -->
            </ul>
        </section>
    </main>

    <footer class="footer">
        <p>&copy; 2025 UDSN Archive. Tous droits réservés.</p>
    </footer>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
    <script>
        // Éléments du DOM
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.querySelector('input[type="file"]');
        const uploadForm = document.getElementById('uploadForm');
        const recentList = document.getElementById('recentList');
        const username = document.getElementById('username');

        // LOGIQUE AJAX MODIFIÉE POUR INCLURE LE NIVEAU
        $(document).ready(function() {
            // Fonction pour réinitialiser les selects
            function resetSelect(selector, defaultText) {
                $(selector).html('<option value="">' + defaultText + '</option>');
            }

            // Quand la faculté, le niveau OU l'année change, charger les filières
            function chargerFilieres() {
                var faculteId = $('#id_faculte').val();
                var niveauId = $('#id_niveau').val();  // NOUVEAU
                var anneeAcademique = $('#id_annee_academique').val();
                var $filiereSelect = $('#id_filiere');
                var $matiereSelect = $('#id_matiere');

                console.log('Chargement filières - Faculté:', faculteId, 'Niveau:', niveauId, 'Année:', anneeAcademique);

                // Réinitialiser les selects dépendants
                resetSelect('#id_filiere', 'Sélectionnez une filière');
                resetSelect('#id_matiere', 'Sélectionnez la matière');

                // Il faut TOUS les 3 paramètres maintenant
                if (faculteId && niveauId && anneeAcademique) {
                    $.get('/deposer/ajax/filieres/' + faculteId + '/' + niveauId + '/' + anneeAcademique + '/')
                        .done(function(data) {
                            console.log('Filières reçues:', data);
                            if (data.length > 0) {
                                $.each(data, function(index, item) {
                                    $filiereSelect.append('<option value="' + item.id + '">' + item.nom + '</option>');
                                });
                            } else {
                                console.log('Aucune filière trouvée pour ces critères');
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error('Erreur AJAX filières:', error);
                            alert('Erreur lors du chargement des filières');
                        });
                }
            }

            // Événements pour faculté, niveau ET année académique
            $('#id_faculte, #id_niveau, #id_annee_academique').change(function() {
                chargerFilieres();
            });

            // Filtrage des matières selon la filière, le niveau ET l'année
            $('#id_filiere').change(function() {
                var filiereId = $(this).val();
                var niveauId = $('#id_niveau').val();  // NOUVEAU
                var anneeAcademique = $('#id_annee_academique').val();  // NOUVEAU
                var $matiereSelect = $('#id_matiere');

                console.log('Chargement matières - Filière:', filiereId, 'Niveau:', niveauId, 'Année:', anneeAcademique);

                // Réinitialiser le select matière
                resetSelect('#id_matiere', 'Sélectionnez la matière');

                if (filiereId && niveauId && anneeAcademique) {
                    $.get('/deposer/ajax/matieres/' + filiereId + '/' + niveauId + '/' + anneeAcademique + '/')
                        .done(function(data) {
                            console.log('Matières reçues:', data);
                            if (data.length > 0) {
                                $.each(data, function(index, item) {
                                    $matiereSelect.append('<option value="' + item.id + '">' + item.nom + '</option>');
                                });
                            } else {
                                console.log('Aucune matière trouvée pour ces critères');
                            }
                        })
                        .fail(function(xhr, status, error) {
                            console.error('Erreur AJAX matières:', error);
                            alert('Erreur lors du chargement des matières');
                        });
                }
            });
        });

        // Gestion du drag & drop (reste identique)
        if (dropZone && fileInput) {
            dropZone.addEventListener('click', () => fileInput.click());

            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.background = '#ffe0e0';
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.style.background = '#ffeaea';
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.style.background = '#ffeaea';
                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    updateFileName(e.dataTransfer.files[0].name);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    updateFileName(e.target.files[0].name);
                }
            });
        }

        function updateFileName(name) {
            const fileNameDisplay = dropZone.querySelector('h3');
            fileNameDisplay.textContent = name;
            dropZone.querySelector('p').textContent = 'Fichier sélectionné';
        }

        // Chargement des fichiers récents
        function loadRecentFiles() {
            const files = JSON.parse(localStorage.getItem('recentFiles') || '[]');
            recentList.innerHTML = '';
            files.slice(0, 5).forEach(file => {
                const li = document.createElement('li');
                li.className = 'file-item';
                li.innerHTML = `
                    <i class="fas fa-file"></i>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">
                            ${file.faculte || 'N/A'} - ${file.niveau || 'N/A'} - ${file.filiere || 'N/A'}<br>
                            ${file.date} - ${file.size || 'N/A'}
                        </div>
                    </div>
                    <div class="file-actions">
                        <i class="fas fa-download action-icon" title="Télécharger"></i>
                        <i class="fas fa-trash action-icon" title="Supprimer"></i>
                    </div>
                `;
                recentList.appendChild(li);
            });
        }

        loadRecentFiles();

        // Fermeture automatique des messages d'alerte
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            });
        }, 5000);
    </script>
</body>
</html>
